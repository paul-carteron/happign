---
title: "Getting started with happign"
author: "Paul Carteron"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting started with happign}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "center",
  fig.height = 4,
  fig.width = 6
)
options(rmarkdown.html_vignette.check_title = FALSE)
```

```{r, include=FALSE}
library(happign)
```

# Context

Since January 1, 2021, the French National Institute for Geographic and Forestry Information (IGN) has made its public data on French topography, infrastructure, and terrain freely available. The opening of IGN data under the Etalab 2.0 open license means free access and use for all.

Among the important data that are now open, we can mention the BD TOPO (3D modeling of the territory and its infrastructures), the BD ORTHO (departmental orthophotography), the BD ForÃªt and the RGE Alti (meshed digital terrain model that describes the French relief). This represents 100 terabytes of data. 

To facilitate access to this data, IGN has implemented a set of APIs based on OGC standards. In other words, it is possible with correctly formatted URLs to access IGN data. In spite of a well supplied documentation, the use of APIs remains complex to set up. The `happign` package has been created to facilitate this, so let's get started.

# Load happign Library

You can install the released version of happign from [CRAN](https://CRAN.R-project.org) with:

``` r
install.packages("happign")
```

And the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("paul-carteron/happign")
```

We can load the `happign` package, and some additional packages we will need while we are here.



```{r message = FALSE, warning = FALSE}
library(happign)
library(sf)
library(tmap)
```


# The WFS, WMS service

`happign` use two data type from IGN web service :

*  WMS raster : data in raster format (.tiff)
*  WFS : data in shape format (.shp).

More detailed information are available [here](https://www.ogc.org/standards/wms) for WMS and [here](https://www.ogc.org/standards/wfs) for WFS.

To download data you need :

 * Its layer name ;
 * The API key corresponding to the layer ;
 * Your area of interest in .shp format

The layer name and API key can be directly retrieved on the [IGN website in the expert web services](https://geoservices.ign.fr/services-web-experts) (I recommend you at this point to go and have a look).

For example, if I take the first category "Administratif", I see that the API key is "administratif" and the first layer name in WFS format is "ADMINEXPRESS-COG.LATEST:arrondissement"

With `happign`, there is no need to go through the website because all api keys are available by running the function `get_apikeys()`.
```{r echo = TRUE}
get_apikeys()
```

After choosing the API key containing our resource, you can access all layer names with `get_layers_metadata()`.

__*Rq :*__

* *This function can be a bit slow because it connects directly to the website so that the information is up to date.*
* *The returned data correspond to the __intersection with the shape bbox__. This is highlighted by the "all" figure below*

```{r}
apikey <- get_apikeys()[1]
get_layers_metadata(apikey = apikey, data_type = "wfs")

```

# Downloading the data
## WFS

For the example we will look at the beautiful town of Penmarch in France and we are going to get these borders.

The `get_wfs()` function connects to WFS service of the IGN that contain borders of the communes. It is also necessary to take a point inside penmarch so that the function detects all the shape that intersect this point.

```{r}
penmarch_point <- st_sfc(st_point(c(-4.370, 47.800)), crs = 4326)
penmarch_borders <- get_wfs(shape = penmarch_point,
                            apikey = "administratif",
                            layer_name = "LIMITES_ADMINISTRATIVES_EXPRESS.LATEST:commune")

# Checking result
tm_shape(penmarch_borders) + # Borders of penmarch
   tm_polygons(alpha = 0, lwd = 2) +
tm_shape(penmarch_point) + # Point use to retrieve data
   tm_dots(col = "red", size = 2) +
   tm_add_legend(type = "symbol", label = "lat : -4.370, long : 47.800",
                 col = "red", size = 1) +
   tm_layout(main.title = "Penmarch borders from IGN",
             main.title.position = "center",
             legend.position = c("right", "bottom"),
             frame = FALSE)
```

It's as simple as that!
Now you have to rely on your curiosity to explore the multiple possibilities that IGN offers. For example, who has never wondered how many road junctions there are in Penmarch?

*Spoiler : there are 220 of them*

```{r}
dikes <- get_wfs(shape = penmarch_borders,
                 apikey = get_apikeys()[6],
                 layer_name = "BDCARTO_BDD_WLD_WGS84G:noeud_routier")

# Checking result
tm_shape(penmarch_borders) + # Borders of penmarch
   tm_polygons(alpha = 0, lwd = 2) +
tm_shape(dikes) + # Point use to retrieve data
   tm_dots(col = "red") +
   tm_add_legend(type = "symbol", label = "Road junction", col = "red") +
   tm_layout(main.title = "Road nodes recorded by the IGN in Penmarch",
             main.title.position = "center",
             legend.position = c("right", "bottom"),
             frame = FALSE)
```

## WMS raster

For raster, the process is the same but with the function `get_wms_raster()`. There's plenty of elevation resources inside ["altimetrie" category](https://geoservices.ign.fr/services-web-experts-altimetrie). The basic one is the Digital Elevation Model (DEM or MNT in French).

__*Rq :*__

 * *The raster is not loaded into R's memory. It is an on-the-fly sequential reading of files from network, without downloading the whole file first. In other words, it is quite possible to access the DEM of an entire region. The counterpart is the connection time which is about 30s;*
 * *Raster from `get_wms_raster()` are stars object from the `stars` package. To learn more about conversion between other raster type in R go [check this out](https://geocompr.github.io/post/2021/spatial-classes-conversion/).*

```{r}
apikey <- get_apikeys()[4]
layers_metadata <- get_layers_metadata("altimetrie", "wms")
dem_layer_name <- layers_metadata[2, "name"]

mnt <- get_wms_raster(shape = penmarch_borders,
                      apikey = apikey,
                      layer_name = dem_layer_name,
                      resolution = 25)
mnt[mnt < 0] <- NA # remove negative values in case of singularity
names(mnt) <- "Elevation [m]" # Rename raster ie the title legend

tm_shape(mnt) +
   tm_raster(colorNA = NULL) +
   tm_layout(title = "DEM of Penmarch", frame = FALSE)
```

